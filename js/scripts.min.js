function ready(t,e,a,r,n,i,o,s,l,c){function d(){function t(){getScrollPct()<=1?(transform(getTransform(getScrollPct(),a)),$("#map-wrapper").removeClass("scrolling").css("margin-top",0)):(transform(a[a.length-1]),$("#map-wrapper").addClass("scrolling").css("margin-top",getStoryHeight())),getScrollPct()>.91&&getScrollPct()<.98?$(".myanmar").fadeOut():getScrollPct()>=.98?$(".myanmar").hide():$(".myanmar").show()}t(),$(window).scroll(t)}function m(t){var e={},a=JSON.parse(JSON.stringify(i));e.type=a.type,e.arcs=a.arcs,e.objects={},e.objects.villages={},e.objects.villages.type=a.objects.villages.type,e.objects.villages.geometries=[];for(var r=0;r<=t;r++){var n=o[r].date;$(".timeline-date").html(o[r].date_text),$(".timeline-villages").html("<span class='red-color'>"+o[r].fires+"</span> villages seen burning"),a.objects.villages.geometries.forEach(function(t){t.properties.date==n&&e.objects.villages.geometries.push(t)})}return e}if(t)throw t;drawSubUnits(r,"myanmar",svg,path),labelMyanmar(r,svg,path);var p=[];e.forEach(function(t){p.push({type:"Feature",properties:{date:t.acq_date,id:t.id},geometry:{type:"Point",coordinates:[+t.longitude,+t.latitude]}})}),drawPoints({type:"FeatureCollection",features:p},svg,path),d();var u=0;centerZoom(s,timeline_svg,timeline_path,timeline_projection,timeline_width,timeline_height),drawSubUnits(r,"myanmar-tl",timeline_svg,timeline_path),drawSubUnits(n,"rakhine-tl",timeline_svg,timeline_path),drawSubUnits(l,"bangladesh-tl",timeline_svg,timeline_path),drawPlaces(c,timeline_svg,timeline_projection),drawVillages(m(0));d3.interval(function(){u==o.length-1?u=-1:++u,drawVillages(m(u))},750)}function drawPlaces(t,e,a){e.selectAll(".place-label").data(topojson.feature(t,t.objects.places).features).enter().append("text").attr("class",function(t){return"place-label "+t.properties.type}).attr("transform",function(t){return"translate("+a(t.geometry.coordinates)+")"}).text(function(t){return t.properties.name})}function drawVillages(t){var e=timeline_svg.selectAll(".circle-village").data(topojson.feature(t,t.objects.villages).features,function(t){return t.properties.id});e.exit().attr("r",3).transition().attr("r",1e-10).remove(),e.transition().style("fill","grey").attr("r",3),e.enter().append("circle").attr("class","circle-village").attr("cx",function(t){return timeline_projection(t.geometry.coordinates)[0]}).attr("cy",function(t){return timeline_projection(t.geometry.coordinates)[1]}).style("fill","red").attr("r",0).transition(1e3).attr("r",6)}function getStoryHeight(){return $(window).height()*$("#story-wrapper").find("p").length}function getTransform(t,e){var a=e.length;return e[Math.round(a*t)]}function getScrollPct(){var t=($(window).height(),getStoryHeight());return $(window).scrollTop()/t}function transform(t){var e=$(window).width(),a=e<=768&&e>480?"x_md":e<=480?"x_sm":"x",r=tile.scale(t.k).translate([t[a],t.y])();projection.scale(t.k/tau).translate([t[a],t.y]),d3.selectAll(".village").attr("d",path),d3.select(".myanmar").attr("d",path),d3.select(".myanmar-label").attr("x",function(t){return path.centroid(t)[0]}).attr("y",function(t){return path.centroid(t)[1]});var n=raster.attr("transform",stringify(r.scale,r.translate)).selectAll("image").data(r,function(t){return t});n.exit().remove(),n.enter().append("image").attr("xlink:href",function(t){return"img/tiles/"+t[2]+"-"+t[0]+"-"+t[1]+".png"}).attr("x",function(t){return 256*t[0]}).attr("y",function(t){return 256*t[1]}).attr("width",256).attr("height",256)}function drawPoints(t,e,a){e.append("path").datum(t).attr("d",a).attr("class","village")}function drawSubUnits(t,e,a,r){a.selectAll(".subunit."+e).data(topojson.feature(t,t.objects.polygons).features).enter().append("path").attr("class","subunit "+e).attr("d",r)}function labelMyanmar(t,e,a){e.selectAll(".myanmar-label").data(topojson.feature(t,t.objects.polygons).features).enter().append("text").attr("class","myanmar-label").attr("x",function(t){return a.centroid(t)[0]}).attr("y",function(t){return a.centroid(t)[1]}).text("Myanmar")}function stringify(t,e){var a=t/256,r=t%1?Number:Math.round;return"translate("+r(e[0]*t)+","+r(e[1]*t)+") scale("+a+")"}function centerZoom(t,e,a,r,n,i){var o=topojson.mesh(t,t.objects.polygons,function(t,e){return t===e});r.scale(1).translate([0,0]);var s=a.bounds(o),l=.8/Math.max((s[1][0]-s[0][0])/n,(s[1][1]-s[0][1])/i),c=[(n-l*(s[1][0]+s[0][0]))/2,(i-l*(s[1][1]+s[0][1]))/2];return r.scale(l).translate(c),o}function drawChart(){function t(t,n){function d(t){t.call(p),t.select(".domain").remove(),t.selectAll(".tick:not(:first-of-type) line").attr("stroke","#777").attr("stroke-dasharray","2,2"),t.selectAll(".tick text").attr("x",4).attr("dy",-4)}n.forEach(function(t){return t.fires=+t.fires,t}),l.domain(n.map(function(t){return t[a]})),c.domain([0,d3.max(n,function(t){return t[r]})]);var m=d3.axisBottom().tickFormat(function(t,e){return t=t.replace(", 2017",""),0==e||"Sep. 1"==t?isMobile&&(0==e&&(t="25/8"),"Sep. 1"==t&&(t="1/9")):t=t.split(". ")[1],t}).scale(l);s.append("g").attr("class","x axis").attr("transform","translate(0, "+o+")").call(m);var p=d3.axisRight(c).tickSize(i).tickFormat(function(t,e,a){return e==a.length-1?t+" fires":t});s.append("g").attr("class","y axis").call(d),e(n)}function e(t){var e=s.selectAll(".bar").data(t,function(t){return t[a]}),n=s.selectAll(".amount").data(t,function(t){return t[a]});e.transition().attr("y",function(t){return c(t[r])}).attr("height",function(t){return o-c(t[r])}),n.transition().attr("y",function(t){return c(t[r])}).text(function(t){return t[r]}),e.enter().append("rect").attr("class","bar").attr("x",function(t){return l(t[a])}).attr("y",function(t){return c(t[r])}).attr("width",l.bandwidth()).attr("height",function(t){return o-c(t[r])}),n.enter().append("text").attr("class","amount").attr("x",function(t){return l(t[a])+l.bandwidth()/2}).attr("y",function(t){return c(t[r])}).attr("dy",16).text(function(t){return 0!=t[r]?t[r]:""})}$("#bar-chart").empty();var a="date_text",r="fires",n=d3.marcon().top(20).bottom(20).width(Math.min(800,window.innerWidth-20)).height(Math.min(400,window.innerHeight-40)).element("#bar-chart");n.render();var i=n.innerWidth(),o=n.innerHeight(),s=n.svg(),l=d3.scaleBand().rangeRound([0,i]).padding(.2),c=d3.scaleLinear().range([o,0]);d3.queue().defer(d3.csv,"data/fires.csv").await(t)}var isMobile=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(isMobile=!0);var resp={};resp.map_width=isMobile?Math.max(window.innerWidth):Math.max(1440,window.innerWidth);var step=0,pi=Math.PI,tau=2*pi,width=resp.map_width,height=Math.max(window.innerHeight,600),projection=d3.geoMercator().scale(1/tau).translate([0,0]),path=d3.geoPath().projection(projection).pointRadius(4),tile=d3.tile().size([width,height]),svg=d3.select("#map-wrapper").attr("width",width).attr("height",height),raster=svg.append("g"),timeline_width=Math.min(800,window.innerWidth),timeline_height=Math.min(500,window.innerHeight),timeline_projection=d3.geoMercator(),timeline_path=d3.geoPath().projection(timeline_projection).pointRadius(2),timeline_svg=d3.select("#timeline-map").append("svg").attr("width",timeline_width).attr("height",timeline_height);timeline_svg.append("rect").attr("width",timeline_width).attr("height",timeline_height).attr("x",0).attr("y",0).attr("fill","#334d5c"),d3.queue().defer(d3.csv,"data/myanmar-fires.csv").defer(d3.json,"data/steps.json").defer(d3.json,"data/myanmar.json").defer(d3.json,"data/rakhine.json").defer(d3.json,"data/villages.json").defer(d3.csv,"data/fires.csv").defer(d3.json,"data/zoom.json").defer(d3.json,"data/bangladesh.json").defer(d3.json,"data/labels.json").await(ready),drawChart(),$(window).smartresize(drawChart);